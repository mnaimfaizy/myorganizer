# cPanel Staging/Testing Environment - MyOrganizer Deployment Plan (API + Static Web)

**Project:** MyOrganizer (API + Web)  
**Environment:** Staging/Testing  
**Hosting:** Namecheap cPanel Shared Hosting  
**Date Created:** January 5, 2026  
**Status:** üìã Ready for Review

---

## üìë Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Nx Monorepo Considerations](#nx-monorepo-considerations)
4. [Deployment Approaches](#deployment-approaches)
5. [Manual Deployment (Recommended for First Deploy)](#manual-deployment-recommended-for-first-deploy)
6. [Automated Deployment with GitHub Actions](#automated-deployment-with-github-actions)
7. [Environment Configuration](#environment-configuration)
8. [Database Setup](#database-setup)
9. [Frontend (Static) Hosting Setup](#frontend-static-hosting-setup)
10. [Troubleshooting](#troubleshooting)
11. [Monitoring & Maintenance](#monitoring--maintenance)

---

## üéØ Overview

This document outlines a deployment strategy for hosting the MyOrganizer backend API (Node/Express) and the MyOrganizer web app (Next.js) as **Node.js applications** on Namecheap cPanel shared hosting.

### Target Domains

- **API:** `https://api.myorganiser.app`
- **Web:** `https://myorganiser.app`

### Key Challenges

1. **Nx Monorepo Structure**: apps live inside an Nx workspace and depend on root-level dependencies.
2. **Shared Hosting Limitations**: limited memory/CPU; installs can time out.
3. **Build Output Packaging**: only deploy what the API needs.
4. **Web Build-Time Config**: `NEXT_PUBLIC_*` env vars are baked into the client bundle at build time.

### Deployment Strategy

We use a **build-and-deploy** approach:

1. Build the backend to a standalone `dist/apps/backend` artifact.
2. Package the backend with Prisma schema/migrations (but generate Prisma client on the server).
3. Build the frontend as a standalone Node app and deploy via cPanel ‚ÄúSetup Node.js App‚Äù.

---

## ‚úÖ Prerequisites

### Local Development

- ‚úÖ Nx workspace is working locally
- ‚úÖ Node.js (v18+) installed
- ‚úÖ Yarn (repo uses Yarn scripts)
- ‚úÖ Git repository with latest code

### cPanel Hosting

- ‚úÖ Namecheap shared hosting account with cPanel access
- ‚úÖ ‚ÄúSetup Node.js App‚Äù available (Node.js 18.x or 20.x)
- ‚úÖ SSH access is strongly recommended
- ‚úÖ PostgreSQL support enabled

### Access Requirements

- cPanel login credentials
- SSH/SFTP credentials (recommended)
- Database credentials
- DNS access (to point subdomains)

---

## üèóÔ∏è Nx Monorepo Considerations

Workspace structure (simplified):

```
myorganizer/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ backend/            # ‚Üê API deployment target
‚îÇ   ‚îî‚îÄ‚îÄ myorganizer/        # ‚Üê Next.js web app (Node.js standalone)
‚îú‚îÄ‚îÄ libs/
‚îú‚îÄ‚îÄ package.json            # ‚Üê root dependencies
‚îî‚îÄ‚îÄ nx.json
```

### Backend Build Output

Backend build output is generated by Nx Webpack with `generatePackageJson: true`:

- Build command: `yarn nx run backend:build`
- Output: `dist/apps/backend/`
  - `main.js` (entry)
  - `package.json` (generated with required dependencies)
  - assets/templates copied from the project

### Frontend Node Output

The frontend is configured for Node deployment via Next.js `output: 'standalone'`.

- Package command: `yarn nx run myorganizer:package`
- Output: `dist/deploy/myorganizer-web/`
  - `server.js` startup file
  - deploy-only `package.json` (generated automatically)
  - `.next/` + `public/` assets

---

## üöÄ Deployment Approaches

### Approach 1: Manual Deployment (Recommended for First Time)

**Pros:** full control, easy to troubleshoot.  
**Cons:** manual updates.

### Approach 2: Automated Deployment (GitHub Actions)

**Pros:** repeatable and fast once stable.  
**Cons:** needs SSH + careful secret handling.

---

## üì¶ Manual Deployment (Recommended for First Deploy)

### Part A ‚Äî Deploy API (Node.js App)

#### Step 1: Build + package the backend

From repo root:

```bash
yarn install

yarn nx run backend:package
```

This produces:

- `dist/deploy/backend-api/`
- `dist/deploy/backend-api/backend-api.zip`

The packaged folder intentionally does **not** include `node_modules`.

#### Step 2: Create the Node.js application in cPanel

1. cPanel ‚Üí **Setup Node.js App** ‚Üí **Create Application**
2. Configure:

```
Node.js Version: 18.x or 20.x
Application Mode: Production
Application Root: myorganizer-api
Application URL: https://api.myorganiser.app
Application Startup File: main.js
```

3. Create the application.

#### Step 3: Upload and extract

Upload `backend-api.zip` to the app root folder (e.g. `~/myorganizer-api/`) and extract.

Ensure `main.js` is at the root of the Node.js app directory.

#### Step 4: Install dependencies

In cPanel Node.js App UI:

- Click **Run NPM Install**

Or via SSH:

```bash
cd ~/myorganizer-api
npm ci --production || npm install --production
```

#### Step 5: Configure environment variables

Prefer cPanel UI ‚Üí Environment Variables. Minimum recommended set:

```bash
NODE_ENV=production
PORT=3000

# API routing
ROUTER_PREFIX=/api/v1

# CORS
CORS_ORIGINS=https://myorganiser.app,https://www.myorganiser.app

# Required in production
SESSION_SECRET=<strong-random-secret>

# Used in email link generation
APP_FRONTEND_URL=https://myorganiser.app

# Database
DATABASE_URL=postgresql://<user>:<pass>@localhost:5432/<db>

# JWT
ACCESS_JWT_SECRET=<strong-random>
REFRESH_JWT_SECRET=<strong-random>
VERIFY_JWT_SECRET=<strong-random>
RESET_JWT_SECRET=<strong-random>
```

#### Step 6: Run Prisma migrations on the server (recommended)

Notes:

- `npm install` runs `prisma generate` automatically (via `postinstall`) so Prisma is built for the server OS.
- Run migrations after `DATABASE_URL` is configured.

Via SSH:

```bash
cd ~/myorganizer-api

# Apply migrations
npm run prisma:migrate:deploy
```

#### Step 7: Restart the Node app

In cPanel Node.js App UI, click **Restart**.

Or (Passenger style):

```bash
touch tmp/restart.txt
```

#### Step 8: Verify API

Examples:

- Swagger UI: `https://api.myorganiser.app/docs`
- Health check (if implemented): add one, otherwise test a known endpoint.

---

### Part B ‚Äî Deploy Web (Node.js App)

#### Step 1: Build + package the web app

The web app prefers a runtime env var (`API_BASE_URL`) so you can change the API endpoint **without rebuilding**.

From repo root:

```bash
# Windows PowerShell
$env:NEXT_PUBLIC_API_BASE_URL='https://api.myorganiser.app/api/v1'
yarn nx run myorganizer:package
```

```bash
# Bash
NEXT_PUBLIC_API_BASE_URL=https://api.myorganiser.app/api/v1 \
  yarn nx run myorganizer:package
```

This produces: `dist/deploy/myorganizer-web/`

#### Step 2: Create a cPanel Node.js app

cPanel ‚Üí Setup Node.js App ‚Üí Create Application:

```
Application Root: myorganizer-web
Application URL: https://myorganiser.app
Startup File: server.js
Application Mode: Production
```

Then click **Run NPM Install** (required) to install runtime dependencies.

#### Step 3: Upload the deployment folder

Upload the contents of `dist/deploy/myorganizer-web/` to the cPanel app root.

#### Step 4: Verify web + API integration

- Load `https://myorganiser.app`
- Confirm API calls go to `https://api.myorganiser.app/api/v1/...`
- Confirm auth flows work (CORS + cookies/tokens)

---

## ‚öôÔ∏è Environment Configuration

### Backend env vars

See the repository example at `.env.example` for the full list.

Key deployment differences:

- `SESSION_SECRET` must be set in production.
- `CORS_ORIGINS` must include `https://myorganiser.app`.
- `APP_FRONTEND_URL` must be your real frontend URL for correct email links.

### Frontend env vars

- Prefer setting `API_BASE_URL` in cPanel (runtime): `API_BASE_URL=https://api.myorganiser.app/api/v1`
- `NEXT_PUBLIC_API_BASE_URL` remains supported as a fallback for local development/builds.

---

## üóÑÔ∏è Database Setup

1. cPanel ‚Üí **PostgreSQL Databases**
2. Create a database and user; grant ALL privileges.
3. Use:

```bash
DATABASE_URL=postgresql://<user>:<pass>@localhost:5432/<db>
```

4. Run migrations (see API deployment step).

---

## üåê Frontend (Node) Hosting Setup

- Create a second Node.js app in cPanel for `myorganiser.app`.
- Startup file is `server.js` from `dist/deploy/myorganizer-web/`.

If you want `www.myorganiser.app` ‚Üí redirect to `myorganiser.app`, configure it in cPanel Domains / Redirects.

---

## üîß Troubleshooting

### 1) CORS errors in browser console

Symptoms:

- "Blocked by CORS policy"

Fix:

- Ensure `CORS_ORIGINS` includes exactly `https://myorganiser.app` (and `https://www.myorganiser.app` if used).
- Restart the Node app after changing env vars.

### 2) API works via curl but frontend fails

Most common causes:

- `API_BASE_URL` is missing or incorrect in cPanel
- router prefix mismatch (`/api/v1`)

Fix:

- Set `API_BASE_URL` in cPanel and restart the Node.js app
- If you must change baked values, rebuild and re-upload the bundle

### 3) Prisma errors on server

If Prisma fails to connect or migrate:

- Re-check `DATABASE_URL`
- Ensure migrations were deployed (`prisma/migrations` exists)
- Re-run:

If you see `Could not load --schema ... prisma/schema: file or directory not found`, you are likely running `npm install` from the **wrong directory**. Ensure your current folder contains `package.json` **and** the uploaded `prisma/` folder (the cPanel ‚ÄúRun NPM Install‚Äù button runs in the app root).

```bash
npm run prisma:generate
npm run prisma:migrate:deploy
```

### 4) Node app won‚Äôt start

Check:

- `stderr.log` / `stdout.log` in app folder
- Missing env vars (especially `SESSION_SECRET`)
- Run `npm ci --production` again if dependencies are missing

---

## üìä Monitoring & Maintenance

- Use cPanel Metrics ‚Üí Errors / Resource Usage
- Add external uptime monitoring for:
  - `https://api.myorganiser.app/docs` (or a health endpoint)
  - `https://myorganiser.app`

Backup recommendations:

- Regular PostgreSQL backups (cron)
- Keep a ‚Äúlast known good‚Äù copy of `dist/deploy/backend-api/backend-api.zip`
- Keep a copy of the last deployed `dist/deploy/myorganizer-web/` bundle

---

## ü§ñ Automated Deployment with GitHub Actions

Once manual deploy is stable, we can automate:

- Backend: build + scp + npm ci + prisma migrate + restart
- Frontend: build + package + upload bundle + restart Node.js app

Prerequisites:

- SSH access enabled
- SSH key stored in GitHub Secrets

(We can add a workflow later tailored to your hosting layout.)
