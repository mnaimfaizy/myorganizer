name: Release PR (auto)

on:
  push:
    branches:
      - 'release/v*'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-pr-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  create-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Create or update PR (release -> main)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const releaseBranch = (context.ref || '').replace('refs/heads/', '');

            if (!/^release\/v\d+\.\d+\.\d+$/.test(releaseBranch)) {
              core.info(`Not a semantic release branch: ${releaseBranch}. Skipping.`);
              return;
            }

            const title = `chore(release): ${releaseBranch.replace('release/', '')}`;
            const body = [
              'Automated release PR.',
              '',
              `- Source: \`${releaseBranch}\``,
              '- Target: `main`',
              '',
              'Auto-merge will be enabled (if repository settings allow it).',
            ].join('\n');

            // Check if a PR already exists.
            const existing = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: 'open',
              base: 'main',
              head: `${owner}:${releaseBranch}`,
              per_page: 100,
            });

            let pr;
            if (existing.length > 0) {
              pr = existing[0];
              core.info(`Found existing PR #${pr.number}`);
            } else {
              pr = await github.rest.pulls.create({
                owner,
                repo,
                title,
                head: releaseBranch,
                base: 'main',
                body,
                maintainer_can_modify: true,
              });

              pr = pr.data;
              core.info(`Created PR #${pr.number}`);
            }

            // Try enabling auto-merge (MERGE) so it merges automatically after CI passes.
            // This requires repo settings: "Allow auto-merge" enabled.
            try {
              const mutation = `
                mutation EnableAutoMerge($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(
                    input: { pullRequestId: $pullRequestId, mergeMethod: MERGE }
                  ) {
                    pullRequest { number }
                  }
                }
              `;

              // GraphQL needs the PR node_id.
              await github.graphql(mutation, { pullRequestId: pr.node_id });
              core.info(`Enabled auto-merge for PR #${pr.number}`);
            } catch (err) {
              core.warning(`Could not enable auto-merge for PR #${pr.number}: ${String(err.message || err)}`);
            }

      - name: Summary
        run: |
          {
            echo "## Release PR automation"
            echo
            echo "- Branch: \`${{ github.ref_name }}\`"
            echo "- Target: \`main\`"
            echo
            echo "If auto-merge is enabled in repo settings, the PR will merge after required checks pass."
          } >> "$GITHUB_STEP_SUMMARY"
