name: Release PR (auto)

on:
  push:
    branches:
      - 'release/v*'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-pr-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  create-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Create or update PR (release -> main)
        uses: actions/github-script@v7
        with:
          # If your org/repo blocks GitHub Actions from creating PRs, provide a PAT:
          # Settings → Secrets and variables → Actions → New repository secret
          # Name: RELEASE_PR_TOKEN
          # Token permissions: Pull requests (Read+Write), Contents (Read+Write)
          github-token: ${{ secrets.RELEASE_PR_TOKEN != '' && secrets.RELEASE_PR_TOKEN || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const releaseBranch = (context.ref || '').replace('refs/heads/', '');

            if (!/^release\/v\d+\.\d+\.\d+$/.test(releaseBranch)) {
              core.info(`Not a semantic release branch: ${releaseBranch}. Skipping.`);
              return;
            }

            const title = `chore(release): ${releaseBranch.replace('release/', '')}`;
            const body = [
              'Automated release PR.',
              '',
              `- Source: \`${releaseBranch}\``,
              '- Target: `main`',
              '',
              'Auto-merge will be enabled (if repository settings allow it).',
            ].join('\n');

            let pr;
            try {
              // Check if a PR already exists.
              const existing = await github.paginate(github.rest.pulls.list, {
                owner,
                repo,
                state: 'open',
                base: 'main',
                head: `${owner}:${releaseBranch}`,
                per_page: 100,
              });

              if (existing.length > 0) {
                pr = existing[0];
                core.info(`Found existing PR #${pr.number}`);
              } else {
                const created = await github.rest.pulls.create({
                  owner,
                  repo,
                  title,
                  head: releaseBranch,
                  base: 'main',
                  body,
                  maintainer_can_modify: true,
                });

                pr = created.data;
                core.info(`Created PR #${pr.number}`);
              }
            } catch (err) {
              const message = String(err?.message || err);
              const status = err?.status || err?.response?.status;
              const blocked =
                status === 403 &&
                /not permitted to create or approve pull requests/i.test(message);

              if (blocked) {
                core.warning('GitHub Actions is not permitted to create PRs in this repository.');
                core.notice(
                  [
                    'Fix options:',
                    '1) Enable repo setting: Settings → Actions → General → Workflow permissions → allow GitHub Actions to create and approve pull requests.',
                    '2) Or add a PAT as secret RELEASE_PR_TOKEN and re-run this workflow.',
                  ].join(' ')
                );
                return;
              }

              throw err;
            }

            // Try enabling auto-merge (MERGE) so it merges automatically after CI passes.
            // This requires repo settings: "Allow auto-merge" enabled.
            try {
              const mutation = `
                mutation EnableAutoMerge($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(
                    input: { pullRequestId: $pullRequestId, mergeMethod: MERGE }
                  ) {
                    pullRequest { number }
                  }
                }
              `;

              // GraphQL needs the PR node_id.
              await github.graphql(mutation, { pullRequestId: pr.node_id });
              core.info(`Enabled auto-merge for PR #${pr.number}`);
            } catch (err) {
              core.warning(`Could not enable auto-merge for PR #${pr.number}: ${String(err.message || err)}`);
            }

      - name: Summary
        run: |
          {
            echo "## Release PR automation"
            echo
            echo "- Branch: \`${{ github.ref_name }}\`"
            echo "- Target: \`main\`"
            echo
            echo "If auto-merge is enabled in repo settings, the PR will merge after required checks pass."
            echo
            echo "If PR creation fails with a 403, enable: Settings → Actions → General → Workflow permissions → allow PR creation,"
            echo "or add a PAT secret named RELEASE_PR_TOKEN (preferred for locked-down org settings)."
          } >> "$GITHUB_STEP_SUMMARY"
