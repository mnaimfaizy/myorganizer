name: Deploy Staging

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  deploy-backend:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Package backend (cPanel)
        run: yarn package:backend:api

      - name: Deploy backend to cPanel (staging)
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/deploy/backend-api/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          timeout: 300000

  deploy-frontend:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    needs: deploy-backend
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Deploy frontend to Vercel (staging)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # NOTE: This workflow deploys to a dedicated Vercel *staging* project.
          # In that project we use its "production" environment for our staging app,
          # therefore the --environment=production and --prod flags are intentional.
          # See VERCEL_FRONTEND_HOSTING.md and CI_CD_AND_RELEASE_PROCESS.md for details.
          #
          # Nx recommends keeping the Vercel project's Root Directory as the workspace root
          # and setting the Build Command to `npx nx build myorganizer --prod`.
          npx vercel@latest pull --yes --environment=production --token "$VERCEL_TOKEN"

          echo '--- Vercel diagnostics (sanitized) ---'
          if [ -d .vercel ]; then
            echo 'Vercel metadata files (names only):'
            find .vercel -maxdepth 2 -type f -print
          else
            echo 'No .vercel directory found after vercel pull.'
          fi

          node <<'NODE'
          const fs = require('fs');
          const path = '.vercel/project.json';
          if (!fs.existsSync(path)) {
            console.log('No .vercel/project.json found (nothing to report).');
            process.exit(0);
          }

          const raw = JSON.parse(fs.readFileSync(path, 'utf8'));
          const settings = raw.settings || {};

          const sanitized = {
            projectId: raw.projectId,
            orgId: raw.orgId,
            settings: {
              framework: settings.framework,
              rootDirectory: settings.rootDirectory,
              installCommand: settings.installCommand,
              buildCommand: settings.buildCommand,
              outputDirectory: settings.outputDirectory,
              nodeVersion: settings.nodeVersion,
            },
          };

          console.log(JSON.stringify(sanitized, null, 2));
          NODE

          echo 'NOTE: Not printing any .vercel/.env* files to avoid leaking secrets.'
          echo '--- end Vercel diagnostics ---'

          # Avoid `--prebuilt`: prebuilt bundles can fail in monorepos due to file-trace
          # references to paths that are not included in the upload.
          npx vercel@latest deploy --prod --yes --token "$VERCEL_TOKEN"
