name: Deploy Production (latest release)

on:
  workflow_dispatch:
  create:

permissions:
  contents: read
  actions: write

concurrency:
  group: deploy-production-latest
  cancel-in-progress: false

jobs:
  dispatch:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'create' && github.event.ref_type == 'branch' && startsWith(github.event.ref, 'release/v')) }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find latest release branch
        id: find
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_TYPE: ${{ github.event.ref_type }}
          CREATED_REF: ${{ github.event.ref }}
        run: |
          set -euo pipefail

          if [[ "${EVENT_NAME}" == 'create' && "${REF_TYPE}" == 'branch' ]]; then
            if [[ ! "${CREATED_REF}" =~ ^release/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Created ref is not a semantic release branch: ${CREATED_REF}" >&2
              exit 1
            fi

            echo "Release branch created: ${CREATED_REF}"
            echo "release_branch=${CREATED_REF}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Selecting latest release branch from origin..."

          latest_branch="$(
            git ls-remote --heads origin 'release/v*' \
              | awk '{print $2}' \
              | sed 's#refs/heads/##' \
              | grep -E '^release/v[0-9]+\.[0-9]+\.[0-9]+$' \
              | sort -V \
              | tail -n 1
          )"

          if [[ -z "${latest_branch}" ]]; then
            echo "No release branches found (expected release/vX.Y.Z)." >&2
            exit 1
          fi

          echo "Latest release branch: ${latest_branch}"
          echo "release_branch=${latest_branch}" >> "$GITHUB_OUTPUT"

      - name: Summary
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## Deploy Production (latest release)"
            echo
            echo "- Latest release branch: `${{ steps.find.outputs.release_branch }}`"
            echo "- Trigger: `${{ github.event_name }}`"
            echo
            echo "This workflow **dispatches** the production deploy workflow for the selected release branch."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Dispatch production deploy workflow
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const releaseBranch = '${{ steps.find.outputs.release_branch }}';

            if (!releaseBranch) {
              core.setFailed('No release_branch output was produced.');
              return;
            }

            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: 'deploy-production.yml',
              ref: releaseBranch,
              inputs: {
                release_branch: releaseBranch,
              },
            });

            core.info(`Dispatched deploy-production.yml on ${releaseBranch}`);
