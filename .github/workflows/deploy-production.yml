name: Deploy Production (manual)

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: 'Release branch to deploy (e.g. release/v0.1.0). Leave empty to auto-select the latest release/* branch.'
        required: false
        type: string

concurrency:
  group: deploy-production
  # Note: deployments are serialized via concurrency; additional runs queue.
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      release_ref: ${{ steps.select_release_ref.outputs.release_ref }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate release branch
        run: |
          set -euo pipefail
          if [[ "$GITHUB_REF" == refs/heads/release/* || "$GITHUB_REF" == refs/heads/main ]]; then
            exit 0
          fi

          echo "ERROR: Production deploy workflow must be run from main or release/* branches."
          echo "Current ref: $GITHUB_REF"
          exit 1

      - name: Select release ref
        id: select_release_ref
        env:
          INPUT_RELEASE_BRANCH: ${{ inputs.release_branch }}
        run: |
          set -euo pipefail

          git fetch origin --prune

          if [ -n "${INPUT_RELEASE_BRANCH:-}" ]; then
            candidate="${INPUT_RELEASE_BRANCH}"
            if ! git show-ref --verify --quiet "refs/remotes/origin/${candidate}"; then
              echo "ERROR: release_branch '${candidate}' not found on origin."
              exit 1
            fi
            echo "release_ref=${candidate}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Auto-select latest origin/release/* using version sort (expects release/vX.Y.Z)
          latest="$(
            git for-each-ref --format='%(refname:short)' refs/remotes/origin/release/
            | sed 's#^origin/##'
            | sed -n 's#^release/v\([0-9]\+\.[0-9]\+\.[0-9]\+\)$#release/v\1#p'
            | sort -V
            | tail -n 1
          )"

          if [ -z "${latest}" ]; then
            echo 'ERROR: No release branches found on origin (expected origin/release/vX.Y.Z).'
            exit 1
          fi

          echo "Selected latest release branch: ${latest}"
          echo "release_ref=${latest}" >> "$GITHUB_OUTPUT"

  deploy-backend:
    if: ${{ startsWith(github.ref, 'refs/heads/release/') || github.ref == 'refs/heads/main' }}
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.validate.outputs.release_ref }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Package backend (cPanel)
        run: yarn package:backend:api

      - name: Deploy backend to cPanel (production)
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.FTP_PROD_HOST }}
          username: ${{ secrets.FTP_PROD_BACKEND_USERNAME }}
          password: ${{ secrets.FTP_PROD_BACKEND_PASSWORD }}
          local-dir: ./dist/deploy/backend-api/
          server-dir: ${{ secrets.FTP_PROD_BACKEND_DIR }}
          timeout: 300000

  deploy-frontend:
    if: ${{ startsWith(github.ref, 'refs/heads/release/') || github.ref == 'refs/heads/main' }}
    needs: deploy-backend
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.validate.outputs.release_ref }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Validate production frontend FTP secrets
        env:
          FTP_PROD_HOST: ${{ secrets.FTP_PROD_HOST }}
          FTP_PROD_FRONTEND_USERNAME: ${{ secrets.FTP_PROD_FRONTEND_USERNAME }}
          FTP_PROD_FRONTEND_PASSWORD: ${{ secrets.FTP_PROD_FRONTEND_PASSWORD }}
          FTP_PROD_FRONTEND_DIR: ${{ secrets.FTP_PROD_FRONTEND_DIR }}
        run: |
          set -euo pipefail
          missing=0

          if [ -z "$FTP_PROD_HOST" ]; then echo 'Missing secret: FTP_PROD_HOST'; missing=1; fi
          if [ -z "$FTP_PROD_FRONTEND_USERNAME" ]; then echo 'Missing secret: FTP_PROD_FRONTEND_USERNAME'; missing=1; fi
          if [ -z "$FTP_PROD_FRONTEND_PASSWORD" ]; then echo 'Missing secret: FTP_PROD_FRONTEND_PASSWORD'; missing=1; fi
          if [ -z "$FTP_PROD_FRONTEND_DIR" ]; then echo 'Missing secret: FTP_PROD_FRONTEND_DIR'; missing=1; fi

          if [ "$missing" -ne 0 ]; then
            echo 'One or more required production frontend FTP secrets are not set (or are empty).'
            exit 1
          fi

      - name: Package frontend (cPanel)
        run: yarn package:myorganizer:web

      - name: Deploy frontend to cPanel (production)
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.FTP_PROD_HOST }}
          username: ${{ secrets.FTP_PROD_FRONTEND_USERNAME }}
          password: ${{ secrets.FTP_PROD_FRONTEND_PASSWORD }}
          local-dir: ./dist/deploy/myorganizer-web/
          server-dir: ${{ secrets.FTP_PROD_FRONTEND_DIR }}
          timeout: 300000
