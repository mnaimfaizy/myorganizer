name: Deploy Production (manual)

on:
  workflow_dispatch:

concurrency:
  group: deploy-production
  # Note: deployments are serialized via concurrency; additional runs queue.
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Validate release branch
        if: ${{ !startsWith(github.ref, 'refs/heads/release/') }}
        run: |
          echo "ERROR: Production deploys are only allowed from release/* branches."
          echo "Current ref: $GITHUB_REF"
          exit 1

  deploy:
    if: ${{ startsWith(github.ref, 'refs/heads/release/') }}
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Package backend (cPanel)
        run: yarn package:backend:api

      - name: Package frontend (cPanel)
        run: yarn package:myorganizer:web

      - name: Deploy backend to cPanel (production)
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.FTP_PROD_HOST }}
          username: ${{ secrets.FTP_PROD_BACKEND_USERNAME }}
          password: ${{ secrets.FTP_PROD_BACKEND_PASSWORD }}
          local-dir: ./dist/deploy/backend-api/
          server-dir: ${{ secrets.FTP_PROD_BACKEND_DIR }}
          timeout: 300000

      - name: Deploy frontend to cPanel (production)
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.FTP_PROD_HOST }}
          username: ${{ secrets.FTP_PROD_FRONTEND_USERNAME }}
          password: ${{ secrets.FTP_PROD_FRONTEND_PASSWORD }}
          local-dir: ./dist/deploy/myorganizer-web/
          server-dir: ${{ secrets.FTP_PROD_FRONTEND_DIR }}
          timeout: 300000
